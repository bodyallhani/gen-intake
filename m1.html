<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/bodyallhani/gen-intake/main/bodyall.png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/bodyallhani/gen-intake/main/bodyall.png">
  <title>기능축 분류 검사 | 바디올 난치 신경-기능센터</title>
  <style>
    :root {
      --bg: #05080f; 
      --card: rgba(255, 255, 255, 0.04);
      --text: #f8fafc;
      --muted: #94a3b8;
      --line: rgba(255, 255, 255, 0.1);
      --radius: 20px;
      
      /* 축별 컬러 체계 */
      --ym: #fbbf24; --gu: #a78bfa; --tu: #34d399; --su: #3b82f6;
      --accent: #ffffff;
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: "Pretendard Variable", Pretendard, -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.6;
      word-break: keep-all;
    }

    .bg-glow {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 50% 0%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
      z-index: -1;
    }

    .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }

    /* Nav */
    .nav {
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
      background: rgba(5, 8, 15, 0.8); border-bottom: 1px solid var(--line);
    }
    .navin { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; }
    .brand { display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit; }
    .logo-dot { width: 20px; height: 20px; border-radius: 5px; background: linear-gradient(135deg, var(--ym), var(--su)); }
    .brand strong { font-size: 14px; }

    /* Intro */
    .hero { padding: 50px 0; text-align: center; }
    .kicker { font-size: 11px; font-weight: 800; color: var(--ym); letter-spacing: 1.5px; margin-bottom: 12px; }
    .hero h1 { font-size: 28px; font-weight: 800; margin: 0 0 16px; line-height: 1.3; letter-spacing: -1px; }
    .hero p { font-size: 15px; color: var(--muted); margin-bottom: 32px; }

    /* Progress */
    .progress-wrap {
      position: sticky; top: 58px; z-index: 90;
      background: var(--bg); padding: 12px 0; margin-bottom: 20px;
    }
    .progress-bar { height: 4px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(to right, var(--ym), var(--su)); transition: width 0.3s ease; }
    .progress-text { font-size: 12px; color: var(--muted); margin-top: 8px; text-align: right; font-weight: 700; }

    /* [핵심 수정] 마지막 문항이 하단 바에 가리지 않도록 여백 추가 */
    #quizForm {
      padding-bottom: 140px; 
    }

    /* Question Cards */
    .q-card { 
      background: var(--card); border: 1px solid var(--line); border-radius: var(--radius);
      padding: 24px; margin-bottom: 20px; animation: fadeIn 0.4s ease both;
    }
    .q-title { font-size: 17px; font-weight: 700; margin-bottom: 20px; line-height: 1.5; color: #fff; }

    /* Options */
    .opt-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .opt {
      background: rgba(255,255,255,0.02); border: 1px solid var(--line);
      padding: 18px 10px; border-radius: 14px; cursor: pointer; text-align: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .opt[data-sel="1"] { 
      background: rgba(255, 255, 255, 0.1); border-color: #fff; color: #fff; 
    }
    .opt strong { font-size: 14px; display: block; font-weight: 600; }

    /* Loading Overlay */
    #loadingScreen {
      display: none; padding: 100px 0; text-align: center; animation: fadeIn 0.5s ease;
    }
    .loader-icon {
      width: 60px; height: 60px; border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--ym); border-radius: 50%;
      margin: 0 auto 30px; animation: spin 1s infinite linear;
    }
    .loader-text { font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 8px; }
    .loader-sub { font-size: 14px; color: var(--muted); }

    /* Result Dashboard */
    .result { display: none; padding: 40px 0 100px; animation: slideUp 0.7s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .result-header { text-align: center; margin-bottom: 32px; }
    .result-header h3 { font-size: 26px; font-weight: 800; margin: 12px 0; }
    .res-badge { display: inline-block; padding: 4px 14px; border-radius: 99px; font-size: 11px; font-weight: 800; border: 1px solid; }

    .score-item { 
      background: var(--card); padding: 20px; border-radius: 18px; border: 1px solid var(--line); 
      margin-bottom: 12px;
    }
    .score-info { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 10px; }
    .bar-bg { height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; }
    .bar-fill { height: 100%; width: 0%; border-radius: 10px; transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 18px 24px; border-radius: 16px; font-weight: 700; font-size: 15px;
      width: 100%; border: none; cursor: pointer; transition: 0.2s;
    }
    .btn.primary { background: #fff; color: #000; }
    .btn.outline { background: transparent; border: 1px solid var(--line); color: var(--muted); }

    .quiz-footer {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: rgba(5, 8, 15, 0.9); backdrop-filter: blur(15px);
      padding: 20px; border-top: 1px solid var(--line);
      display: flex; gap: 10px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div class="bg-glow"></div>

  <header class="nav">
    <div class="navin">
      <a class="brand" href="mainland.html">
        <div class="logo-dot"></div>
        <strong>기능축 정밀 진단</strong>
      </a>
      <a href="mainland.html" style="font-size: 12px; color: var(--muted); font-weight: 600;">나가기</a>
    </div>
  </header>

  <main class="container">
    <section class="hero" id="introSec">
      <div class="kicker">Bodyall Functional Medicine</div>
      <h1>내 몸의 무너진<br><span style="background: linear-gradient(to right, var(--ym), var(--su)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">핵심 패턴</span> 찾기</h1>
      <p>12가지 증상 데이터를 분석하여<br>가장 시급한 신체 복구 우선순위를 제안합니다.</p>
      <button class="btn primary" onclick="startQuiz()">진단 시작하기 (30초)</button>
    </section>

    <section class="panel" id="quizPanel" style="display: none;">
      <div class="progress-wrap">
        <div class="progress-bar"><div class="progress-fill" id="pbar"></div></div>
        <div class="progress-text" id="ptext">0 / 12</div>
      </div>
      <form id="quizForm"></form>
      <div class="quiz-footer">
        <button class="btn outline" style="flex: 1;" onclick="resetQuiz()">초기화</button>
        <button class="btn primary" style="flex: 2;" onclick="calculateResult()">결과 분석하기</button>
      </div>
    </section>

    <section id="loadingScreen">
      <div class="loader-icon"></div>
      <div class="loader-text" id="loaderMsg">증상 데이터 매칭 중...</div>
      <div class="loader-sub">당신의 신체 기능 리듬을 분석하고 있습니다.</div>
    </section>

    <section class="result" id="resultBox">
      <div class="result-header">
        <div id="resBadge" class="res-badge">DIAGNOSIS COMPLETE</div>
        <h3 id="axisTitle">분석 결과</h3>
        <p id="axisDesc" style="color: var(--muted); font-size: 15px; padding: 0 10px;"></p>
      </div>
      <div id="scoreGrid"></div>
      <div style="margin-top: 40px; text-align: center; padding: 0 10px;">
        <a class="btn primary" id="goAxisBtn" href="#">정밀 분석 리포트 보기</a>
        <p id="redirText" style="font-size: 12px; color: var(--muted); margin-top: 20px; font-weight: 600;">5초 후 자동으로 상세 페이지로 이동합니다.</p>
      </div>
    </section>
  </main>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzDRDzsJR4DqaO1mtbvOgIn4v1XKcPpKN5Bb6M6SySD_ifVlamEFc0-jsSb_oZCVyEc/exec";

    const AX = {
      ym: { name: "양명축: 소화·대사", color: "#fbbf24", file: "ym.html", desc: "위장의 따뜻한 대사 에너지가 정체된 패턴입니다. 대사 리듬 안정을 최우선으로 합니다." },
      gu: { name: "궐음축: 자율신경", color: "#a78bfa", file: "gu.html", desc: "신경계의 조율 시스템이 과각성된 패턴입니다. 고요한 조절력 회복이 필요합니다." },
      tu: { name: "태음축: 면역·호흡", color: "#34d399", file: "tu.html", desc: "외부 자극에 대한 면역 방어막이 약해진 패턴입니다. 세포 결속력 보강이 시급합니다." },
      su: { name: "소음축: 회복·에너지", color: "#3b82f6", file: "su.html", desc: "근본적인 수기(水氣)와 에너지가 고갈된 패턴입니다. 심부 에너지 재생이 핵심입니다." }
    };

    const QUESTIONS = [
      { t:"식후에 더부룩하거나, 속이 묵직하게 불편한 편이다.", w:{ym:2}},
      { t:"역류감/트림/가슴 답답 같은 느낌이 자주 있다.", w:{ym:2, gu:1}},
      { t:"변(설사/변비/가스)이 컨디션에 따라 자주 흔들린다.", w:{ym:2, gu:1, su:1}},
      { t:"스트레스를 받으면 증상이 확 올라오거나 변동이 커진다.", w:{gu:2, ym:1, su:1}},
      { t:"두근거림/긴장/예민함이 자주 느껴지고 몸이 먼저 반응한다.", w:{gu:2, su:1}},
      { t:"잠이 얕거나 자주 깨고, 자도 개운하지 않은 날이 많다.", w:{gu:2, su:2}},
      { t:"환절기나 피로 시 비염·기침·가래가 쉽게 발생한다.", w:{tu:2, su:1}},
      { t:"감기나 각종 염증이 잦거나 한 번 걸리면 오래 가는 편이다.", w:{tu:2, su:1}},
      { t:"피부 가려움/트러블이 컨디션 저하와 함께 악화된다.", w:{tu:2, su:1}},
      { t:"아침이 특히 힘들고, 몸이 풀리는 데 시간이 오래 걸린다.", w:{su:2}},
      { t:"조금만 무리해도 회복에 며칠이 걸리고 쉽게 방전된다.", w:{su:2}},
      { t:"손발이 차거나 무기력이 쉽게 올라오고 지구력이 떨어진다.", w:{su:2}}
    ];

    const SCALE = [ { v:0, a:"전혀 아님" }, { v:1, a:"가끔" }, { v:2, a:"자주" }, { v:3, a:"거의 항상" } ];

    function startQuiz() {
      document.getElementById("introSec").style.display = "none";
      document.getElementById("quizPanel").style.display = "block";
      buildQuiz();
      window.scrollTo(0, 0);
    }

    function buildQuiz() {
      const form = document.getElementById("quizForm");
      form.innerHTML = "";
      QUESTIONS.forEach((q, idx) => {
        const div = document.createElement("div");
        div.className = "q-card";
        div.innerHTML = `
          <div class="q-title">${idx + 1}. ${q.t}</div>
          <div class="opt-grid">
            ${SCALE.map(s => `<div class="opt" onclick="selectOpt(this, ${idx}, ${s.v})"><strong>${s.a}</strong></div>`).join("")}
          </div>
          <input type="hidden" id="q${idx}" value="" />
        `;
        form.appendChild(div);
      });
    }

    function selectOpt(el, qIdx, val) {
      document.getElementById(`q${qIdx}`).value = val;
      el.parentElement.querySelectorAll(".opt").forEach(o => o.setAttribute("data-sel", "0"));
      el.setAttribute("data-sel", "1");
      updateProgress();
    }

    function updateProgress() {
      let answered = 0;
      QUESTIONS.forEach((_, i) => { if(document.getElementById(`q${i}`).value !== "") answered++; });
      document.getElementById("pbar").style.width = (answered / QUESTIONS.length) * 100 + "%";
      document.getElementById("ptext").textContent = `${answered} / ${QUESTIONS.length}`;
    }

    async function calculateResult() {
      let allFilled = true;
      const qValues = [];
      QUESTIONS.forEach((_, i) => { 
        const val = document.getElementById(`q${i}`).value;
        if(val === "") allFilled = false; 
        qValues.push(val);
      });
      if(!allFilled) { alert("모든 문항에 체크해 주세요."); return; }

      document.getElementById("quizPanel").style.display = "none";
      document.getElementById("loadingScreen").style.display = "block";
      window.scrollTo(0, 0);

      const msgs = ["증상 데이터 매칭 중...", "기능축 불균형 판별 중...", "최적의 복구 플랜 산출 중..."];
      let msgIdx = 0;
      const msgInterval = setInterval(() => {
        msgIdx++;
        if(msgIdx < msgs.length) document.getElementById("loaderMsg").textContent = msgs[msgIdx];
      }, 800);

      const scores = { ym:0, gu:0, tu:0, su:0 };
      const maxPossible = { ym:0, gu:0, tu:0, su:0 };
      QUESTIONS.forEach((q, i) => {
        const v = parseInt(qValues[i]);
        Object.keys(AX).forEach(k => {
          scores[k] += v * (q.w[k] || 0);
          maxPossible[k] += 3 * (q.w[k] || 0);
        });
      });
      const norm = {};
      Object.keys(scores).forEach(k => norm[k] = Math.round((scores[k] / maxPossible[k]) * 100));
      const winner = Object.entries(norm).sort((a,b) => b[1] - a[1])[0][0];

      localStorage.setItem("genIntakeAxis", winner);
      localStorage.setItem("genIntakeScores", JSON.stringify({ axis: winner, scores: norm }));

      // [핵심] 구글 시트로 데이터 전송 (백그라운드)
      sendDataToSheet(norm, winner, qValues);

      setTimeout(() => {
        clearInterval(msgInterval);
        showResult(winner, norm);
      }, 2500);
    }

    function sendDataToSheet(norm, type, qVals) {
      const formData = new URLSearchParams();
      formData.append("ym", norm.ym);
      formData.append("gu", norm.gu);
      formData.append("tu", norm.tu);
      formData.append("su", norm.su);
      formData.append("type", type);
      
      qVals.forEach((val, i) => {
        formData.append(`q${i}`, val);
      });

      fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors", // CORS 문제 방지
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
      }).catch(err => console.error("Data Sync Error:", err));
    }

    function showResult(winner, norm) {
      document.getElementById("loadingScreen").style.display = "none";
      document.getElementById("resultBox").style.display = "block";

      const ax = AX[winner];
      const badge = document.getElementById("resBadge");
      badge.style.color = ax.color;
      badge.style.borderColor = ax.color;
      document.getElementById("axisTitle").textContent = ax.name;
      document.getElementById("axisTitle").style.color = ax.color;
      document.getElementById("axisDesc").textContent = ax.desc;

      const grid = document.getElementById("scoreGrid");
      grid.innerHTML = "";
      [ {k:'ym', l:'소화·대사', c:AX.ym.color}, {k:'gu', l:'자율신경', c:AX.gu.color}, {k:'tu', l:'면역·호흡', c:AX.tu.color}, {k:'su', l:'회복·에너지', c:AX.su.color} ]
      .forEach(item => {
        const v = norm[item.k];
        grid.innerHTML += `<div class="score-item"><div class="score-info"><span>${item.l}</span><strong>${v}%</strong></div><div class="bar-bg"><div class="bar-fill" style="width:${v}%; background:${item.c}"></div></div></div>`;
      });

      const targetUrl = `${ax.file}?from=m1&axis=${winner}`;
      document.getElementById("goAxisBtn").href = targetUrl;

      let sec = 5;
      const timer = setInterval(() => {
        sec--;
        document.getElementById("redirText").textContent = `${sec}초 후 리포트 페이지로 이동합니다.`;
        if(sec <= 0) { clearInterval(timer); window.location.href = targetUrl; }
      }, 1000);
    }

    function resetQuiz() { if(confirm("답변을 초기화할까요?")) { buildQuiz(); updateProgress(); window.scrollTo(0,0); } }
  </script>
</body>
</html>
